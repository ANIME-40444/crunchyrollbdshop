<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<title>Crunchyroll Premium BD Shop</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0; padding: 0;
    background: #fff;
    color: #000;
  }
  .container {
    max-width: 900px;
    margin: auto;
    padding: 20px;
    position: relative;
  }
  .page { display: none; }
  .active { display: block; }
  button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    background: #007bff;
    color: #fff;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
  input, select {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    box-sizing: border-box;
  }
  .error { color: red; margin-top: 10px; }
  /* থ্রি ডট আইকন */
  #menuToggle {
    position: fixed;
    top: 15px;
    right: 15px;
    width: 35px;
    height: 35px;
    background: #007bff;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #menuToggle:hover {
    background: #0056b3;
  }
  #menuToggle div {
    width: 6px;
    height: 6px;
    background: #fff;
    border-radius: 50%;
    margin: 2px 0;
  }
  /* Dropdown menu */
  #dropdownMenu {
    display: none;
    position: fixed;
    top: 55px;
    right: 15px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 140px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 1000;
  }
  #dropdownMenu.active {
    display: block;
  }
  #dropdownMenu button {
    width: 100%;
    background: none;
    color: #007bff;
    font-weight: bold;
    border: none;
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  #dropdownMenu button:hover {
    background: #f0f0f0;
  }
  /* Order list table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    font-size: 14px;
  }
  th {
    background: #007bff;
    color: white;
  }
  /* Status buttons */
  .status-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    margin-right: 5px;
  }
  .confirm-btn {
    background-color: green;
    color: white;
  }
  .reject-btn {
    background-color: red;
    color: white;
  }
  /* Status text colors */
  .status-pending { color: orange; font-weight: bold; }
  .status-confirmed { color: green; font-weight: bold; }
  .status-rejected { color: red; font-weight: bold; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

<div id="menuToggle" title="Menu">
  <div></div><div></div><div></div>
</div>
<div id="dropdownMenu">
  <button id="orderListBtn">Orders</button>
</div>

<div class="container">

  <!-- Main Page -->
  <div id="mainPage" class="page active">
    <h1>Crunchyroll Premium BD Shop</h1>
    <button onclick="showPage('packagePage')">BUY NOW</button>
    <p>
      <strong>Total Users:</strong> <span id="userCount">0</span> |
      <strong>Total Orders:</strong> <span id="orderCount">0</span>
    </p>
  </div>

  <!-- Package Page -->
  <div id="packagePage" class="page">
    <h2>প্যাকেজ সিলেক্ট করুন</h2>
    <button onclick="selectPackage('Shared Profile', '1 Month', 100)">Shared Profile - 1 Month - 100 TK</button>
    <button onclick="selectPackage('Shared Profile', '3 Months', 300)">Shared Profile - 3 Months - 300 TK</button>
    <button onclick="selectPackage('Personal Profile', '1 Month', 240)">Personal Profile - 1 Month - 240 TK</button>
    <button onclick="selectPackage('Primary Account', '1 Month', 650)">Primary Account - 1 Month - 650 TK</button>
    <button onclick="showPage('mainPage')">Back to Home</button>
    <p id="pkgError" class="error"></p>
  </div>

  <!-- Checkout Page -->
  <div id="checkoutPage" class="page">
    <h2>Checkout</h2>
    <div id="selectedPackageInfo"></div>

    <input type="text" id="coName" placeholder="পুরো নাম" />
    <input type="email" id="coEmail" placeholder="ইমেইল" />
    <input type="text" id="coAddress" placeholder="ঠিকানা" />
    <input type="text" id="coMobile" placeholder="মোবাইল নম্বর" />
    <select id="paymentMethod" onchange="updatePaymentNumber()">
      <option value="">-- পেমেন্ট মেথড সিলেক্ট করুন --</option>
      <option value="Bkash">Bkash</option>
      <option value="Nagad">Nagad</option>
      <option value="Rocket">Rocket</option>
    </select>
    <input type="text" id="coPaymentNumber" placeholder="পেমেন্ট নম্বর" readonly />
    <input type="text" id="coTransID" placeholder="ট্রানজেকশন আইডি" />

    <p>অবশ্যই নির্দিষ্ট পরিমাণ পাঠাবেন। কম পাঠালে রিফান্ড হবে না।</p>

    <button onclick="confirmOrder()">Order Confirm</button>
    <button onclick="showPage('packagePage')">Back to Packages</button>

    <p id="coError" class="error"></p>
  </div>

  <!-- Orders Status Page -->
  <div id="ordersPage" class="page">
    <h2>তোমার অর্ডারসমূহ</h2>
    <table>
      <thead>
        <tr>
          <th>প্যাকেজ</th>
          <th>মেয়াদ</th>
          <th>মূল্য</th>
          <th>স্ট্যাটাস</th>
          <th>অ্যাকশন</th>
        </tr>
      </thead>
      <tbody id="orderListBody">
        <!-- অর্ডার লিস্ট এখানে যাবে -->
      </tbody>
    </table>
    <button onclick="showPage('mainPage')">Back to Home</button>
  </div>

  <!-- Admin Panel Page -->
  <div id="adminPage" class="page">
    <h2>Admin Panel - Orders</h2>
    <table>
      <thead>
        <tr>
          <th>নাম</th>
          <th>ইমেইল</th>
          <th>মোবাইল</th>
          <th>প্যাকেজ</th>
          <th>মেয়াদ</th>
          <th>মূল্য</th>
          <th>স্ট্যাটাস</th>
          <th>Confirm</th>
          <th>Reject</th>
        </tr>
      </thead>
      <tbody id="adminOrderListBody">
      </tbody>
    </table>
    <button onclick="showPage('mainPage')">Back to Home</button>
  </div>

</div>

<script>
  // তোমার Firebase config এখানে বসাও
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // EmailJS config বসাও
  const emailjsConfig = {
    service: 'YOUR_SERVICE_ID',
    adminTpl: 'YOUR_ADMIN_TEMPLATE_ID',
    custTpl: 'YOUR_CUSTOMER_TEMPLATE_ID',
    publicKey: 'YOUR_PUBLIC_KEY',
  };
  emailjs.init(emailjsConfig.publicKey);

  // পেজ শো করার ফাংশন
  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'ordersPage') loadUserOrders();
    if(id === 'adminPage') loadAdminOrders();
  }

  // থ্রি ডট মেনু টগল
  const menuToggle = document.getElementById('menuToggle');
  const dropdownMenu = document.getElementById('dropdownMenu');

  menuToggle.addEventListener('click', () => {
    dropdownMenu.classList.toggle('active');
  });

  // ড্রপডাউন থেকে অর্ডার পেজে যাওয়ার বাটন
  document.getElementById('orderListBtn').addEventListener('click', () => {
    dropdownMenu.classList.remove('active');
    showPage('ordersPage');
  });

  // ইউজার এবং অর্ডার সংখ্যা আপডেট
  function startListeners() {
    db.collection('users').onSnapshot(snap => {
      document.getElementById('userCount').textContent = snap.size;
    });
    db.collection('orders').onSnapshot(snap => {
      document.getElementById('orderCount').textContent = snap.size;
    });
  }
  startListeners();

  // প্যাকেজ সিলেক্ট ও চেকআউট পেজ দেখানো
  let selectedPkg = null;
  function selectPackage(profile, duration, price) {
    selectedPkg = { profile, duration, price };
    document.getElementById('pkgError').textContent = '';
    showPage('checkoutPage');
    document.getElementById('selectedPackageInfo').innerHTML = `
      <p>প্যাকেজ: <strong>${profile}</strong></p>
      <p>মেয়াদ: <strong>${duration}</strong></p>
      <p>মূল্য: <strong>${price} TK</strong></p>
    `;
    updatePaymentNumber();
    document.getElementById('coPaymentNumber').value = '';
    document.getElementById('coTransID').value = '';
  }

  // পেমেন্ট মেথড অনুযায়ী নম্বর
  function updatePaymentNumber() {
    const method = document.getElementById('paymentMethod').value;
    let number = '';
    if(method === 'Bkash') number = '01740433733';
    else if(method === 'Nagad' || method === 'Rocket') number = '01603599843';
    document.getElementById('coPaymentNumber').value = number;
  }

  // অর্ডার কনফার্মেশন
  async function confirmOrder() {
    const name = document.getElementById('coName').value.trim();
    const email = document.getElementById('coEmail').value.trim();
    const address = document.getElementById('coAddress').value.trim();
    const mobile = document.getElementById('coMobile').value.trim();
    const paymentNumber = document.getElementById('coPaymentNumber').value.trim();
    const transId = document.getElementById('coTransID').value.trim();
    const paymentMethod = document.getElementById('paymentMethod').value;

    const errorP = document.getElementById('coError');
    errorP.textContent = '';

    if(!name || !email || !address || !mobile || !paymentNumber || !transId || !paymentMethod) {
      errorP.textContent = 'সব তথ্য সঠিকভাবে পূরণ করুন।';
      return;
    }
    if(!selectedPkg) {
      errorP.textContent = 'প্যাকেজ নির্বাচন করুন।';
      return;
    }

    const orderData = {
      ...selectedPkg,
      name,
      email,
      address,
      mobile,
      paymentNumber,
      transId,
      paymentMethod,
      status: 'Pending',  // প্রথমে পেন্ডিং থাকবে
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      // অর্ডার ডাটাবেজে যোগ করা
      await db.collection('orders').add(orderData);

      // ইউজার হিসেবে যোগ করা (যদি নতুন হয়)
      const userDoc = await db.collection('users').doc(email).get();
      if(!userDoc.exists) {
        await db.collection('users').doc(email).set({email, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
      }

      // ইমেইল পাঠানো (দুটি টেমপ্লেট)
      await emailjs.send(emailjsConfig.service, emailjsConfig.custTpl, orderData);
      await emailjs.send(emailjsConfig.service, emailjsConfig.adminTpl, orderData);

      alert('অর্ডার সফলভাবে জমা হয়েছে!');

      // অর্ডার লিস্ট পেজে নিয়ে যাওয়া
      showPage('ordersPage');

    } catch (error) {
      alert('অর্ডার জমা দিতে সমস্যা হয়েছে: ' + error.message);
    }
  }

  // ইউজারের অর্ডারগুলো লোড করব
  async function loadUserOrders() {
    const tbody = document.getElementById('orderListBody');
    tbody.innerHTML = '<tr><td colspan="5">লোড হচ্ছে...</td></tr>';
    // ইউজার ইমেইল চাইবো (সিম্পল: এখনো কোন লগিন নেই, তাই তুমি কাস্টমার ইমেইল ইনপুট নাও)
    let userEmail = prompt("অনুগ্রহ করে তোমার ইমেইল লিখুন (অর্ডার দেখতে):");
    if(!userEmail) {
      tbody.innerHTML = '<tr><td colspan="5">ইমেইল প্রয়োজন।</td></tr>';
      return;
    }

    // ফিল্টার করে দেখাও ওই ইমেইলের অর্ডার
    try {
      const snapshot = await db.collection('orders')
        .where('email', '==', userEmail.trim())
        .orderBy('createdAt', 'desc')
        .get();

      if(snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="5">কোন অর্ডার পাওয়া যায়নি।</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        let statusClass = 'status-pending';
        if(data.status === 'Confirmed') statusClass = 'status-confirmed';
        else if(data.status === 'Rejected') statusClass = 'status-rejected';

        tbody.innerHTML += `<tr>
          <td>${data.profile}</td>
          <td>${data.duration}</td>
          <td>${data.price} TK</td>
          <td class="${statusClass}">${data.status}</td>
          <td>--</td>
        </tr>`;
      });

    } catch (error) {
      tbody.innerHTML = '<tr><td colspan="5">লোড করতে সমস্যা: ' + error.message + '</td></tr>';
    }
  }

  // এডমিন প্যানেলে অর্ডার লোড করা
  async function loadAdminOrders() {
    const tbody = document.getElementById('adminOrderListBody');
    tbody.innerHTML = '<tr><td colspan="9">লোড হচ্ছে...</td></tr>';

    try {
      const snapshot = await db.collection('orders').orderBy('createdAt', 'desc').get();

      if(snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="9">কোন অর্ডার পাওয়া যায়নি।</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const id = doc.id;

        let statusClass = 'status-pending';
        if(data.status === 'Confirmed') statusClass = 'status-confirmed';
        else if(data.status === 'Rejected') statusClass = 'status-rejected';

        tbody.innerHTML += `<tr>
          <td>${data.name}</td>
          <td>${data.email}</td>
          <td>${data.mobile}</td>
          <td>${data.profile}</td>
          <td>${data.duration}</td>
          <td>${data.price} TK</td>
          <td class="${statusClass}">${data.status}</td>
          <td><button class="status-btn confirm-btn" onclick="updateOrderStatus('${id}','Confirmed')">Confirm</button></td>
          <td><button class="status-btn reject-btn" onclick="updateOrderStatus('${id}','Rejected')">Reject</button></td>
        </tr>`;
      });

    } catch (error) {
      tbody.innerHTML = '<tr><td colspan="9">লোড করতে সমস্যা: ' + error
